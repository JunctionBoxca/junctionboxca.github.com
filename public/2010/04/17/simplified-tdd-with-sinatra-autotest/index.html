<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" manifest="default.appcache?v=1" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">

  <title>Simplified TDD with Sinatra autotest - JunctionBox.ca</title>
  <meta name="author" content="Nathan Fisher">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">
	<meta name="google-site-verification" content="gx9_z4OF2J_NJP3cWIO2RDcRivQG4pDBijLQTDwal1k" />

  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--<script src="/javascripts/octopress.js" type="text/javascript"></script>-->
  <script src="javascripts/libs/modernizr-1.7.min.js"></script>
  <script src="javascripts/libs/ios-viewport-scaling-bug-fix.js"></script>
  
    <script src="http://www.google-analytics.com/ga.js" type="text/javascript"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '#{page.google_analytics_tracking_id}']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();
</script>

  
  <link href="/atom.xml" rel="alternate" title="JunctionBox.ca" type="application/atom+xml"/>
</head>

<body  >
  <header><div><h1><a href="/">JunctionBox.ca</a></h1>
</div></header>
  <nav><div><div>
  <a href="/atom.xml">Subscribe</a>
  <form action="http://google.com/search" method="get">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:junctionbox.ca" />
  </form>
</div>
<ul>
  <li><a href="/?s=nav">Home</a></li>
  <li><a href="/nathan-fisher.html?s=nav">About</a></li>
  <li><a href="/archive/?s=nav">Archive</a></li>
  <li><a href="/resources/?s=nav">Resources</a></li>
</ul>
</div></nav>
  <div>
    <div>
      <div id="articles"><article>
  <header>
  <h1><a href="/2010/04/17/simplified-tdd-with-sinatra-autotest/">Simplified TDD with Sinatra autotest</a></h1>
  <p>
    
      <span class="byline author vcard">By <span class="fn">Nathan Fisher</span></span>
    
    
      <time datetime="Sat Apr 17 00:00:00 -0700 2010" pubdate>April 17<span>th</span>, 2010</time>
    
    
  </p>
</header>

<div class="entry"><p>General overview of what we&#8217;re building;</p>
<ul>
	<li>Simple autotest compatible directory structure.</li>
	<li>Sinatra application.</li>
	<li>Sinatra unit test.</li>
</ul>
<p>File setup:</p>
<div class="highlight"><pre><code class="bash"><span class="nb">export </span><span class="nv">project</span><span class="o">=</span>MyApp
mkdir -p <span class="nv">$project</span>/<span class="o">{</span>lib,test<span class="o">}</span>
<span class="nb">cd</span> <span class="nv">$project</span>
cat <span class="s">&lt;&lt;EOT &gt; test/test_app.rb</span>
<span class="s">$:.unshift File.join(File.dirname(__FILE__),&#39;..&#39;,&#39;lib&#39;)</span>

<span class="s">require &#39;app&#39;</span>
<span class="s">require &#39;test/unit&#39;</span>

<span class="s">class AppTest &lt; Test::Unit::TestCase</span>
<span class="s">  def test_fail</span>
<span class="s">    flunk &#39;Write your App tests!&#39;</span>
<span class="s">  end</span>
<span class="s">end</span>
<span class="s">EOT</span>

autotest
</code></pre>
</div><p>This should output something akin to the following, if you don&#8217;t get that then somethings amiss that you&#8217;ll need to investigate further.</p>
<div class="highlight"><pre><code class="ruby"><span class="sr">/Library/</span><span class="no">Ruby</span><span class="o">/</span><span class="no">Site</span><span class="o">/</span><span class="mi">1</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">rubygems</span><span class="o">/</span><span class="n">custom_require</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">31</span><span class="ss">:in</span> <span class="sb">`gem_original_require&#39;: no such file to load -- app (LoadError)</span>
<span class="sb">	from /Library/Ruby/Site/1.8/rubygems/custom_require.rb:31:in `</span><span class="nb">require</span><span class="s1">&#39;</span>
<span class="s1">	from ./test/test_app.rb:4</span>
<span class="s1">	from /Library/Ruby/Site/1.8/rubygems/custom_require.rb:31:in `gem_original_require&#39;</span>
	<span class="n">from</span><span class="sr"> /Library/</span><span class="no">Ruby</span><span class="o">/</span><span class="no">Site</span><span class="o">/</span><span class="mi">1</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">rubygems</span><span class="o">/</span><span class="n">custom_require</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">31</span><span class="ss">:in</span> <span class="sb">`require&#39;</span>
<span class="sb">	from -e:2</span>
<span class="sb">	from -e:2:in `</span><span class="n">each</span><span class="err">&#39;</span>
	<span class="n">from</span> <span class="o">-</span><span class="n">e</span><span class="p">:</span><span class="mi">2</span>
</code></pre>
</div><p>Next create a new file named &#8216;lib/app.rb&#8217;.</p>
<div class="highlight"><pre><code class="bash">touch lib/app.rb
</code></pre>
</div><p>Once saved your test should kick to life with one failure:</p>
<div class="highlight"><pre><code class="ruby"><span class="mi">1</span><span class="p">)</span> <span class="no">Failure</span><span class="p">:</span>
<span class="n">test_fail</span><span class="p">(</span><span class="no">AppTest</span><span class="p">)</span> <span class="o">[.</span><span class="n">/</span><span class="nb">test</span><span class="o">/</span><span class="n">test_app</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">8</span><span class="o">]</span><span class="p">:</span>
<span class="no">Write</span> <span class="n">your</span> <span class="no">App</span> <span class="n">tests!</span><span class="o">.</span>
</code></pre>
</div><p>Hugely simplified test suite, but it gets you going and doesn&#8217;t contain reams of mystical cruft to debug.</p>
<p>Next up is introducing rack&#8217;s test suite, modify your test_app.rb to look like the following;</p>
<div class="highlight"><pre><code class="ruby"><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;lib&#39;</span><span class="p">)</span>

<span class="nb">require</span> <span class="s1">&#39;app&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;rack/test&#39;</span>

<span class="n">set</span> <span class="ss">:environment</span><span class="p">,</span> <span class="ss">:test</span>

<span class="k">class</span> <span class="nc">AppTest</span> <span class="o">&lt;</span> <span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">App</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">test_fail</span>
    <span class="n">flunk</span> <span class="s1">&#39;Write your App tests!&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div><p>Back to a test that doesn&#8217;t run? Good!</p>
<p>Let&#8217;s get it back to a running test with the following change to &#8216;lib/app.rb&#8217;:</p>
<div class="highlight"><pre><code class="ruby"><span class="sx">%w{rubygems sinatra}</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">l</span><span class="o">|</span> <span class="nb">require</span> <span class="n">l</span> <span class="p">}</span>
</code></pre>
</div><p>Now you should have a failing test.  Lets start on something meaningful remove the test_fail method and add the following:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">test_root_is_accessible</span>
  <span class="n">get</span> <span class="s1">&#39;/&#39;</span>
  <span class="n">assert</span> <span class="n">last_response</span><span class="o">.</span><span class="n">ok?</span>
<span class="k">end</span>
</code></pre>
</div><p>Your autotest should switch to the error output below:</p>
<div class="highlight"><pre><code class="ruby"><span class="mi">1</span><span class="p">)</span> <span class="no">Error</span><span class="p">:</span>
<span class="n">test_root_is_accessible</span><span class="p">(</span><span class="no">AppTest</span><span class="p">):</span>
<span class="no">NameError</span><span class="p">:</span> <span class="n">uninitialized</span> <span class="n">constant</span> <span class="no">AppTest</span><span class="o">::</span><span class="no">App</span>
<span class="o">.</span><span class="n">/</span><span class="nb">test</span><span class="o">/</span><span class="n">test_app</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">13</span><span class="ss">:in</span> <span class="sb">`app&#39;</span>
</code></pre>
</div><p>That&#8217;s an indicator we&#8217;re missing our application class.  Dealing with one problem at a time lets implement the skeleton class in &#8216;lib/app.rb&#8217; as outlined below.</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
</div><p>You should get a failing test case with the output below, which indicates the route is not found.</p>
<div class="highlight"><pre><code class="ruby"><span class="mi">1</span><span class="p">)</span> <span class="no">Failure</span><span class="p">:</span>
<span class="n">test_root_is_accessible</span><span class="p">(</span><span class="no">AppTest</span><span class="p">)</span> <span class="o">[.</span><span class="n">/</span><span class="nb">test</span><span class="o">/</span><span class="n">test_app</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">18</span><span class="o">]</span><span class="p">:</span>
<span class="o">&lt;</span><span class="kp">false</span><span class="o">&gt;</span> <span class="n">is</span> <span class="ow">not</span> <span class="kp">true</span><span class="o">.</span>
</code></pre>
</div><p>Next up lets add the route in &#8216;lib/app.rb&#8217;.</p>
<div class="highlight"><pre><code class="ruby"><span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre>
</div><p>And there we go our first of hopefully many tests is now passing, congratulations!</p>
<p>For the source see;</p>
<p><a href="git://github.com/nfisher/Sinatra-Skeleton.git">git://github.com/nfisher/Sinatra-Skeleton.git</a></p></div>


  
    <div id="disqus_thread"><script type="text/javascript">
  var disqus_url = "http://junctionbox.ca/2010/04/17/simplified-tdd-with-sinatra-autotest/";
</script>
<noscript>
  <a href="http://junctionboxca.disqus.com/?url=ref">View the discussion thread</a>
</noscript>
<script type="text/javascript" src="http://disqus.com/forums/junctionboxca/embed.js"></script>
</div>
  
</article>
</div>
      
        <aside><section>
<img src="http://www.myopenid.com/image?id=142724" alt="Nathan Fisher" width="170" height="95"/>
<h2>JunctionBox.ca</h2> 
<h3>Nathan Fisher - DevOp</h3>
 
<p class="quiet">DevOps is a common sense approach to software release cycles. It's an accumulation of best practices and the agreement that software has no business value until it's in the hands of its intended user. The name is derived from the curious union of development and operations and is most commonly described as a "bridge of communication" between developers and operations. Criticise if you will, but when people have their head in code they sometimes don't take into account the bigger picture. Ultimately that's what it's all about. Common tools of the trade include: virtualization, configuration management, CI, and automation of as much as reasonable. If you're interested in knowing more take a look at Jez Humbles book <a href="http://continuousdelivery.com/">Continuous Delivery</a>.</p>
</section>



<section>
  <h3>Recent Posts</h3>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/05/28/branching-by-abstraction-101/">Branching by Abstraction 101</a>
        <time>May 28, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2011/02/10/bootstrapping-windows/">Bootstrapping Windows</a>
        <time>February 10, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2010/10/05/initial-configuration-of-puppetd-on-os-x/">Initial Configuration of Puppetd on OS X</a>
        <time>October 05, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/08/01/dance-and-pivot-sql-style/">Dance and Pivot SQL Style</a>
        <time>August 01, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/04/17/simplified-tdd-with-sinatra-autotest/">Simplified TDD with Sinatra autotest</a>
        <time>April 17, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/03/24/dom-a-regato--my-tests-are-auto/">Dom A Regato, My Tests Are Auto</a>
        <time>March 24, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/02/23/fresh-book-it/">Fresh Book It</a>
        <time>February 23, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2009/12/12/approaching-bliss--tdd%2Bphp%2Bmvc/">Approaching bliss; TDD+PHP+MVC</a>
        <time>December 12, 2009</time>
      </li>
    
      <li class="post">
        <a href="/2009/11/03/kick-dependence--here-s-an-injection/">Kick dependence, here's an injection</a>
        <time>November 03, 2009</time>
      </li>
    
      <li class="post">
        <a href="/2009/06/17/tripping-over-rubies-while-camping/">Tripping over Rubies while Camping</a>
        <time>June 17, 2009</time>
      </li>
    
  </ul>
	<p><a href="/archive/?s=sidebar">More Articles</a></p>
</section>


<section>
<h3>Blog Roll</h3>
<ul>
      <li><a href="http://dailyinteractive.ca/">DailyInteractive.ca</a></li>
      <li><a href="http://migz.ca/">Migz.ca</a></li>
      <li><a href="http://etlgfx.com/">ETL gfx</a></li>
      <li><a href="http://littlekitchen.ca/">Little Kitchen</a></li>
      <li><a href="http://matthewkantor.com/">Matthew Kantor</a></li>
      <li><a href="http://continuousdelivery.com/">Continous Delivery - Jez Humble</a></li>
      <li><a href="http://www.samnewman.org/">Sam Newman</a></li>
      </ul>
</section>


  <section><h3>Latest Tweets</h3>
<ul id="tweets">
  Status updating...
</ul>
<p>Follow <a href="http://twitter.com/junctionboxca">@junctionboxca</a></p>

  <script>
    var twitter_user = "junctionboxca";
    var show_replies = false;
    var tweet_count = 3;
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"></script>

</section>



</aside>
      
    </div>
  </div>
  <footer><div><p>
	<a href="/?s=footer">Home</a> |
	<a href="/nathan-fisher.html?s=footer">About</a> |
	<a href="/archive/?s=footer">Archive</a> |
	<a href="/resources/?s=footer">Resources</a> |
  Copyright &copy; 2011 - Nathan Fisher -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</div></footer>
  <!--[if (lt IE 9) & (!IEMobile)]>
  <script src="javascripts/libs/DOMAssistantCompressed-2.8.js"></script>
  <script src="javascripts/libs/selectivizr-1.0.1.js"></script>
  <script src="javascripts/libs/respond.min.js"></script>
  <![endif]-->
</body>
</html>
