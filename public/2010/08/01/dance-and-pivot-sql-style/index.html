<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" manifest="default.appcache?v=1" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">

  <title>Dance and Pivot SQL Style - JunctionBox.ca</title>
  <meta name="author" content="Nathan Fisher">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">

  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--<script src="/javascripts/octopress.js" type="text/javascript"></script>-->
  <script src="javascripts/libs/modernizr-1.7.min.js"></script>
  <script src="javascripts/libs/ios-viewport-scaling-bug-fix.js"></script>
  
    <script src="http://www.google-analytics.com/ga.js" type="text/javascript"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '#{page.google_analytics_tracking_id}']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();
</script>

  
  <link href="/atom.xml" rel="alternate" title="JunctionBox.ca" type="application/atom+xml"/>
</head>

<body  >
  <header><div><h1><a href="/">JunctionBox.ca</a></h1>
</div></header>
  <nav><div><div>
  <a href="/atom.xml">Subscribe</a>
  <form action="http://google.com/search" method="get">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:junctionbox.ca" />
  </form>
</div>
<ul>
  <li><a href="/?s=nav">Home</a></li>
  <li><a href="/nathan-fisher.html?s=nav">About</a></li>
  <li><a href="/archive/?s=nav">Archive</a></li>
  <li><a href="/resources/?s=nav">Resources</a></li>
</ul>
</div></nav>
  <div>
    <div>
      <div id="articles"><article>
  <header>
  <h1><a href="/2010/08/01/dance-and-pivot-sql-style/">Dance and Pivot SQL Style</a></h1>
  <p>
    
      <span class="byline author vcard">By <span class="fn">Nathan Fisher</span></span>
    
    
      <time datetime="Sun Aug 01 00:00:00 -0700 2010" pubdate>August 1<span>st</span>, 2010</time>
    
    
  </p>
</header>

<div class="entry"><p>Found myself looking at Open Flash Charts for a reporting system.  I wanted to create page views broken down by day.  A simplified schema is as follows:</p>
<table>
	<tr>
		<td> id </td>
		<td> created_at </td>
		<td> page </td>
	</tr>
	<tr>
		<td> Integer </td>
		<td> DateTime </td>
		<td> Varchar(255) </td>
	</tr>
</table>
<p>I wanted to create a table like the following:</p>
<table>
	<tr>
		<td> page </td>
		<td> monday </td>
		<td> tuesday </td>
		<td> wednesday </td>
		<td> thursday </td>
		<td> friday </td>
		<td> saturday </td>
		<td> sunday </td>
	</tr>
	<tr>
		<td> index </td>
		<td> 3 </td>
		<td> 5 </td>
		<td> 2 </td>
		<td> 8 </td>
		<td> 9 </td>
		<td> 30 </td>
		<td> 32 </td>
	</tr>
	<tr>
		<td> contact </td>
		<td> 2 </td>
		<td> 1 </td>
		<td> 4 </td>
		<td> 3 </td>
		<td> 7 </td>
		<td> 12 </td>
		<td> 16 </td>
</table>
\nMy first though was just do a simple GROUP BY and pivot the table through code.<pre>
SELECT page, DATE(created_at), COUNT(*) AS hits 
FROM page_views
GROUP BY DATE(created_at), page ORDER BY page;
</pre>
<p>I figured I could alternatively use temp tables but, I had an itch to find out if there was another way using pure <span class="caps">SQL</span> and no temp tables.  During my search I ran across all sorts of queries some obscure head scratchers.  After much frustration I started reading the MySQL for any reprieve particularly the section on <a href="http://dev.mysql.com/doc/refman/5.1/en/functions.html">functions and operators</a>.  After a small meal and some strange query results I ran into a presentation created by <a href="http://datacharmer.org/">Giuseppe Maxia</a> aka the &#8220;Data Charmer&#8221;.  I reamed through his presentation and found what I was looking for in the form of a 2 query crosstab.  I reformulated his query to suit my needs and came up with the following:</p>
<pre>
SELECT page_name AS name,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS mon,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS tues,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS wed,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS thurs,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS fri,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS sat,
COUNT(CASE WHEN DATE(created_at) = '?' THEN id ELSE null END) AS sun,
COUNT(CASE WHEN DATE(created_at) 
  IN ('?','?','?','?','?','?','?')
  THEN id ELSE null END) AS total
FROM page_views GROUP BY name
</pre>
<p>What are your thoughts? Any similar implementations how did you handle it?</p></div>


  
    <div id="disqus_thread"><script type="text/javascript">
  var disqus_url = "http://junctionbox.ca/2010/08/01/dance-and-pivot-sql-style/";
</script>
<noscript>
  <a href="http://junctionboxca.disqus.com/?url=ref">View the discussion thread</a>
</noscript>
<script type="text/javascript" src="http://disqus.com/forums/junctionboxca/embed.js"></script>
</div>
  
</article>
</div>
      
        <aside><section>
<img src="http://www.myopenid.com/image?id=142724" alt="Nathan Fisher" width="170" height="95"/>
<h2>JunctionBox.ca</h2> 
<h3>Nathan Fisher - DevOp</h3>
 
<p class="quiet">DevOps is a common sense approach to software release cycles. It's an accumulation of best practices and the agreement that software has no business value until it's in the hands of its intended user. The name is derived from the curious union of development and operations and is most commonly described as a "bridge of communication" between developers and operations. Criticise if you will, but when people have their head in code they sometimes don't take into account the bigger picture. Ultimately that's what it's all about. Common tools of the trade include: virtualization, configuration management, CI, and automation of as much as reasonable. If you're interested in knowing more take a look at Jez Humbles book <a href="http://continuousdelivery.com/">Continuous Delivery</a>.</p>
</section>



<section>
  <h3>Recent Posts</h3>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/05/28/branching-by-abstraction-101/">Branching by Abstraction 101</a>
        <time>May 28, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2011/02/10/bootstrapping-windows/">Bootstrapping Windows</a>
        <time>February 10, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2010/10/05/initial-configuration-of-puppetd-on-os-x/">Initial Configuration of Puppetd on OS X</a>
        <time>October 05, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/08/01/dance-and-pivot-sql-style/">Dance and Pivot SQL Style</a>
        <time>August 01, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/04/17/simplified-tdd-with-sinatra-autotest/">Simplified TDD with Sinatra autotest</a>
        <time>April 17, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/03/24/dom-a-regato--my-tests-are-auto/">Dom A Regato, My Tests Are Auto</a>
        <time>March 24, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/02/23/fresh-book-it/">Fresh Book It</a>
        <time>February 23, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2009/12/12/approaching-bliss--tdd%2Bphp%2Bmvc/">Approaching bliss; TDD+PHP+MVC</a>
        <time>December 12, 2009</time>
      </li>
    
      <li class="post">
        <a href="/2009/11/03/kick-dependence--here-s-an-injection/">Kick dependence, here's an injection</a>
        <time>November 03, 2009</time>
      </li>
    
      <li class="post">
        <a href="/2009/06/17/tripping-over-rubies-while-camping/">Tripping over Rubies while Camping</a>
        <time>June 17, 2009</time>
      </li>
    
  </ul>
	<p><a href="/archive/?s=sidebar">More Articles</a></p>
</section>


<section>
<h3>Blog Roll</h3>
<ul>
      <li><a href="http://dailyinteractive.ca/">DailyInteractive.ca</a></li>
      <li><a href="http://migz.ca/">Migz.ca</a></li>
      <li><a href="http://etlgfx.com/">ETL gfx</a></li>
      <li><a href="http://littlekitchen.ca/">Little Kitchen</a></li>
      <li><a href="http://matthewkantor.com/">Matthew Kantor</a></li>
      <li><a href="http://continuousdelivery.com/">Continous Delivery - Jez Humble</a></li>
      <li><a href="http://www.samnewman.org/">Sam Newman</a></li>
      </ul>
</section>


  <section><h3>Latest Tweets</h3>
<ul id="tweets">
  Status updating...
</ul>
<p>Follow <a href="http://twitter.com/junctionboxca">@junctionboxca</a></p>

  <script>
    var twitter_user = "junctionboxca";
    var show_replies = false;
    var tweet_count = 3;
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"></script>

</section>



</aside>
      
    </div>
  </div>
  <footer><div><p>
	<a href="/?s=footer">Home</a> |
	<a href="/nathan-fisher.html?s=footer">About</a> |
	<a href="/archive/?s=footer">Archive</a> |
	<a href="/resources/?s=footer">Resources</a> |
  Copyright &copy; 2011 - Nathan Fisher -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</div></footer>
  <!--[if (lt IE 9) & (!IEMobile)]>
  <script src="javascripts/libs/DOMAssistantCompressed-2.8.js"></script>
  <script src="javascripts/libs/selectivizr-1.0.1.js"></script>
  <script src="javascripts/libs/respond.min.js"></script>
  <![endif]-->
</body>
</html>
