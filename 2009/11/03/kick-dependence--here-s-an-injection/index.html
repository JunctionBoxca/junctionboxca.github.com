<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7" manifest="default.appcache?v=1"><![endif]-->
<!--[if lt IE 7 ]><html class="no-js ie6" lang="en"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7" lang="en"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8" lang="en"><![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" manifest="default.appcache?v=1" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">

  <title>Kick dependence, here's an injection - JunctionBox.ca</title>
  <meta name="author" content="Nathan Fisher">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1">

  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--<script src="/javascripts/octopress.js" type="text/javascript"></script>-->
  <script src="javascripts/libs/modernizr-1.7.min.js"></script>
  <script src="javascripts/libs/ios-viewport-scaling-bug-fix.js"></script>
  
    <script src="http://www.google-analytics.com/ga.js" type="text/javascript"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '#{page.google_analytics_tracking_id}']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();
</script>

  
  <link href="/atom.xml" rel="alternate" title="JunctionBox.ca" type="application/atom+xml"/>
</head>

<body  >
  <header><div><h1><a href="/">JunctionBox.ca</a></h1>
</div></header>
  <nav><div><div>
  <a href="/atom.xml">Subscribe</a>
  <form action="http://google.com/search" method="get">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:junctionbox.ca" />
  </form>
</div>
<ul>
  <li><a href="/?s=nav">Home</a></li>
  <li><a href="/about/?s=nav">About</a></li>
  <li><a href="/archive/?s=nav">Archive</a></li>
</ul>
</div></nav>
  <div>
    <div>
      <div id="articles"><article>
  <header>
  <h1><a href="/2009/11/03/kick-dependence--here-s-an-injection/">Kick dependence, here's an injection</a></h1>
  <p>
    
      <span class="byline author vcard">By <span class="fn">Nathan Fisher</span></span>
    
    
      <time datetime="Tue Nov 03 00:00:00 -0800 2009" pubdate>November 3<span>rd</span>, 2009</time>
    
    
  </p>
</header>

<div class="entry"><p>Recently I have been mulling the benefits of Dependency Injection in relationship to <span class="caps">PHP</span>.  I still question it&#8217;s need, but I felt like an experiment for the fun of it.</p>
<p>First I laid out the general interface I wanted to work with.  You may recognize it as being very similar to  <a href="http://onestepback.org/index.cgi/Tech/Ruby/DependencyInjectionInRuby.rdoc">this</a> shamelessly &#8220;php&#8217;ized&#8221; ruby code.</p>
<pre>
function create_app() {
 $container = new DI_Container( );
 $container-&gt;register( 'logfilename', 'logfile.log' );
 $container-&gt;register( 'db_user', 'nfisher' );
 $container-&gt;register( 'db_pass', 'secret' );
 $container-&gt;register( 'dbi_string', 'db:host:and:stuff' );

 $container-&gt;register( 'authenticator', function($c) {
  return new Authenticator( $c-&gt;database, $c-&gt;logger, $c-&gt;error_handler );
} );

 $container-&gt;register('error_handler', function($c) {
  $errh = new ErrorHandler( );
  $errh-&gt;logger = $c-&gt;logger;
  return $errh;
} );

 $container-&gt;register('logger', function($c) {
  return new Logger( $c-&gt;logfilename );
} );

 $container-&gt;register('database', function($c) {
  return new DB( $c-&gt;dbi_string, $c-&gt;db_user, $c-&gt;db_pass );
} );

 $container-&gt;register('quotes', function($c) {
  return new StockQuotes( $c-&gt;error_handler, $c-&gt;logger );
} );

 $container-&gt;register('webapp', function($c) { 
  $app = new WebApp( $c-&gt;quotes, $c-&gt;authenticator, $c-&gt;database );
  $app-&gt;logger = $c-&gt;logger;
  $app-&gt;set_error_handler( $c-&gt;error_handler );
  return $app;
} );
}
</pre><p>\nNow I had a couple issues with the above implementation; string constants, and anonymous functions.</p>
<h3>String Constants Aren&#8217;t Unknown Objects</h3>
<p>The DB/logfile config are not really dependencies.  It seems better to decouple them into a configuration class that can be initialized based on environment (ie/ dev, test, prod).</p>
<h3>Absence of Anonymous Functions</h3>
<p>Unfortunately my production environment is php 5.2, anonymous functions&#8230;5.3 so its a simple problem of what&#8217;s more important&#8230; existing well tested env won out on that one.</p>
<p>So I created a simple function binder with the following interface;</p>
<pre>
interface Applyable {
 public function each( $o );
}

class FunctionBinder implements Applyable {
  private $_f_name;

  public function __construct( $f_name ) {
    $this-&gt;_f_name;
  }

  /** each: Calls the stored function by name and passes the DI container as a reference. 
   */
  public function each( $c ) {
    return call_user_func( $this-&gt;_f_name, $c );
  }
}
</pre>
<p>The anonymous function became named;</p>
<pre>
function create_logger( $c ) {
  return new Logger( $c-&gt;logfilename );
}
</pre>
<p>And the register became;</p>
<p><code>$container-&gt;register('logger', new FunctionBinder('create_logger') );</code></p>
<h3>Code check in aisle 3&#8230; code check</h3>
<p>Trying to be a good little coder I built my tests first for the container.  I decided I would use the __get method to build the graphs the question was how!  My first naive approach was to throw exceptions from the __get method for currently incomplete objects.  As exceptions were thrown an immediate depth of dependencies would be identified through the exception handler&#8230;okay it&#8217;ll work, but it ain&#8217;t gonna be pretty.  If your dependencies are spectacularly out of order it seems like an excessive unwinding of the call stack will occur just to keep the code down.</p>
<h3>Testing 1.. 2</h3>
<p>The next thought that occurred to me was why not include the dependencies with the registration process?</p>
<p><code>$container-&gt;register( 'logger', new FunctionBinder('create_logger'), 'logfilename' );</code></p>
<p>It seemed simple, but I didn&#8217;t like it.  My dependencies were clearly defined inside of the create_logger function. Why duplicate effort, especially when it could potentially lead to an error.</p>
<h3>Put on trial and Execute</h3>
<p>While cooking dinner it dawned on me, why should the objects be instantiated directly? After all the goal is to minimize the usage of the new operator?  Factories to the rescue!</p>
<pre>
function create_logger( $c ) {
 return $c-&gt;build( Logger, $c-&gt;logfilename );
}
</pre>
<p>How does that change things?  Well it allows for a 2 phase process;</p>
<p>Phase 1: Evaluate dependencies.<br />
Phase 2: Instantiate objects.</p>
<p>During Phase 1 no objects are actually built.  Instead evaluate the object requests and associate their dependencies.<br />
Phase 2 is executed as soon as each objects dependencies are fulfilled. If an object has all of its dependencies fulfilled immediately then it is instantiated, otherwise it sits on the back burner waiting for it&#8217;s time.</p>
<p>I have a direction, stay tuned for the final product!</p></div>


  
    <div id="disqus_thread"><script type="text/javascript">
  var disqus_url = "http://junctionbox.ca/2009/11/03/kick-dependence--here-s-an-injection/";
</script>
<noscript>
  <a href="http://junctionboxca.disqus.com/?url=ref">View the discussion thread</a>
</noscript>
<script type="text/javascript" src="http://disqus.com/forums/junctionboxca/embed.js"></script>
</div>
  
</article>
</div>
      
        <aside><section>
<img src="http://www.myopenid.com/image?id=142724" alt="Nathan Fisher"/>
<h2>JunctionBox.ca</h2> 
<h3>Nathan Fisher - DevOp</h3>
 
<p class="quiet">DevOps is a common sense approach to software release cycles. It's an accumulation of best practices and the agreement that software has no business value until it's in the hands of its intended user. The name is derived from the curious union of development and operations and is most commonly described as a "bridge of communication" between developers and operations. Criticise if you will, but when people have their head in code they sometimes don't take into account the bigger picture. Ultimately that's what it's all about. Common tools of the trade include: virtualization, configuration management, CI, and automation of as much as reasonable. If you're interested in knowing more take a look at Jez Humbles book <a href="http://continuousdelivery.com/">Continuous Delivery</a>.</p>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/05/28/branching-by-abstraction-101/">Branching by Abstraction 101</a>
        <time>May 28, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2011/02/10/gated-checkins/">Thinking Gated checkins are the Solution?</a>
        <time>February 10, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2011/02/10/bootstrapping-windows/">Bootstrapping Windows</a>
        <time>February 10, 2011</time>
      </li>
    
      <li class="post">
        <a href="/2010/10/05/initial-configuration-of-puppetd-on-os-x/">Initial Configuration of Puppetd on OS X</a>
        <time>October 05, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/08/01/dance-and-pivot-sql-style/">Dance and Pivot SQL Style</a>
        <time>August 01, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/04/17/simplified-tdd-with-sinatra-autotest/">Simplified TDD with Sinatra autotest</a>
        <time>April 17, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/03/24/dom-a-regato--my-tests-are-auto/">Dom A Regato, My Tests Are Auto</a>
        <time>March 24, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2010/02/23/fresh-book-it/">Fresh Book It</a>
        <time>February 23, 2010</time>
      </li>
    
      <li class="post">
        <a href="/2009/12/12/approaching-bliss--tdd%2Bphp%2Bmvc/">Approaching bliss; TDD+PHP+MVC</a>
        <time>December 12, 2009</time>
      </li>
    
      <li class="post">
        <a href="/2009/11/03/kick-dependence--here-s-an-injection/">Kick dependence, here's an injection</a>
        <time>November 03, 2009</time>
      </li>
    
  </ul>
	<p><a href="/archive/?s=sidebar">More Articles</a></p>
  </section>


  <section><h1>Latest Tweets</h1>
<ul id="tweets">
  Status updating...
</ul>
<p>Follow <a href="http://twitter.com/junctionboxca">@junctionboxca</a></p>

  <script>
    var twitter_user = "junctionboxca";
    var show_replies = false;
    var tweet_count = 3;
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"></script>

</section>



</aside>
      
    </div>
  </div>
  <footer><div><p>
	<a href="/?s=footer">Home</a> |
	<a href="/about/?s=footer">About</a> |
	<a href="/archive/?s=footer">Archive</a> |
  Copyright &copy; 2011 - Nathan Fisher -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</div></footer>
  <!--[if (lt IE 9) & (!IEMobile)]>
  <script src="javascripts/libs/DOMAssistantCompressed-2.8.js"></script>
  <script src="javascripts/libs/selectivizr-1.0.1.js"></script>
  <script src="javascripts/libs/respond.min.js"></script>
  <![endif]-->
</body>
</html>
